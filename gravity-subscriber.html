<script type="text/javascript">
	RED.nodes.registerType('Gravity Subscriber', {
		category: 'function',
		color: '#EF5350',
		credentials: {
			appID: { type: 'text' },
			accessKey: { type: 'text' }
		},
		defaults: {
			name: {
				value: ""
			},
			server: {
				value: "",
				type: "Gravity Server"
			},
			subscriberID: {
				value: "",
			},
			enabledAuth: {
				value: false,
			},
			initialLoad: {
				value: false,
			},
			collections: {
				value: [], 
			},
		},
		inputs: 0,
		outputs: 1,
		icon: 'gravity-icon-white.png',
		label: function() {
				return this.name || 'Gravity Subscriber';
		},
		oneditprepare: function() {

			// Enable Auth
			function updateAuthOptions() {
				if ($("#node-input-enabledAuth").is(':checked')) {
					$("#node-row-auth").show();
				} else {
					$("#node-row-auth").hide();
				}
			}

			updateAuthOptions();
            $("#node-input-enabledAuth").on("click",function() {
                updateAuthOptions();
            });

			// Initializing editable list
            var collectionList = $("#node-input-collections-container").css('min-height','150px').css('min-width','450px').editableList({
                addItem: function(container, i, data) {
                    var row = $('<div/>').css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap',
                        display: 'flex'
                    }).appendTo(container);

                    var propertyValueCell = $('<div/>').css({'flex-grow':1,'margin-left':'10px'}).appendTo(row);
                    var propertyValue = $('<input/>',{class:"node-input-collection-value",type:"text",style:"width: 100%"})
                        .appendTo(propertyValueCell)
                        .typedInput({
							type: 'str',
						})
						.typedInput('value', data)
                },
                removable: true
            });

            if (this.collections) {
				this.collections.forEach(function(collection) {
					collectionList.editableList('addItem', collection);
				});
            }
        },
        oneditsave: function() {

            var node = this;

			// Getting all of items from editable list
            var collections = $("#node-input-collections-container").editableList('items');

			// Update array
            node.collections = [];
            collections.each(function(i) {
                var header = $(this);
                var v = header.find(".node-input-collection-value").typedInput('value');

				node.collections.push(v);
            });
        },
        oneditresize: function(size) {
            var rows = $('#dialog-form>div:not(.node-input-collections-container-row)');
            var height = size.height;
            for (var i = 0; i < rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-collections-container-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));

            $('#node-input-collections-container').editableList('height',height);
        }
    });
</script>

<script type="text/x-red" data-template-name="Gravity Subscriber">
	<div class="form-row">
        <label for="node-input-name" style="width: 130px"><i class="fa fa-stack-exchange"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-subscriberID" style="width: 130px"><i class="fa fa-stack-exchange"></i> Subscriber ID</label>
        <input type="text" id="node-input-subscriberID" placeholder="(Random)">
    </div>
    <div class="form-row">
        <label for="node-input-server" style="width: 130px"><i class="fa fa-server"></i> Server</label>
        <input type="text" id="node-input-server" placeholder="localhost:4222">
    </div>
    <div class="form-row">
        <input type="checkbox" id="node-input-enabledAuth" value="EnabledAuth" style="display:inline-block; width: auto; vertical-align: top;">
        <label for="node-input-enabledAuth" style="width: auto"> Enable Authentication</label>
		<div id="node-row-auth" style="margin-left: 20px" class="hide">
			<div class="form-row">
				<label for="node-input-appID"><i class="fa fa-id-card"></i> App ID</label>
				<input type="text" id="node-input-appID" placeholder="App ID">
			</div>
			<div class="form-row">
				<label for="node-input-accessKey"><i class="fa fa-key"></i> Access Key</label>
				<input type="text" id="node-input-accessKey" placeholder="Access Key">
			</div>
		</div>
    </div>
    <div class="form-row">
        <input type="checkbox" id="node-input-initialLoad" value="InitialLoad" style="display:inline-block; width: auto; vertical-align: top;">
        <label for="node-input-initialLoad" style="width: auto"> Perform the initial load for the first time</label>
    </div>
	<div style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> Collection subscriptions</label>
    </div>
    <div class="form-row node-input-collections-container-row">
        <ol id="node-input-collections-container"></ol>
    </div>
</script>

<script type="text/html" data-help-name="Gravity Subscriber">
	<p>Subscribe to Gravity data node</p>
</script>
